# HAE æ¨¡å‹è„šæœ¬é€‚é…æ£€æŸ¥æŠ¥å‘Š

## æ¦‚è¿°

æœ¬æŠ¥å‘Šè¯¦ç»†æ£€æŸ¥äº† HAEï¼ˆHeterogeneous Attention Enhancementï¼‰æ¨¡å‹çš„è®­ç»ƒè„šæœ¬ã€æ¨ç†è„šæœ¬å’Œå·¥å…·æ–‡ä»¶çš„é€‚é…æƒ…å†µï¼Œç¡®ä¿å®ƒä»¬èƒ½å¤Ÿæ­£ç¡®æ”¯æŒä¿®æ”¹åçš„ HAE ç½‘ç»œç»“æ„ã€‚

## æ£€æŸ¥èŒƒå›´

### 1. è®­ç»ƒè„šæœ¬
- `scripts/train_hae.py` - HAE åŸç‰ˆè®­ç»ƒè„šæœ¬
- `scripts/train_hae_lite.py` - HAE Lite è®­ç»ƒè„šæœ¬
- `scripts/train_hae_v2.py` - HAE V2 è®­ç»ƒè„šæœ¬

### 2. æ¨ç†è„šæœ¬
- `scripts/translation_FPDM_hae.py` - HAE åŸç‰ˆæ¨ç†è„šæœ¬
- `scripts/translation_FPDM_hae_lite.py` - HAE Lite æ¨ç†è„šæœ¬
- `scripts/translation_FPDM_hae_v2.py` - HAE V2 æ¨ç†è„šæœ¬

### 3. å·¥å…·æ–‡ä»¶
- `guided_diffusion/script_util.py` - æ¨¡å‹åˆ›å»ºå’Œé…ç½®å·¥å…·
- `scripts/common.py` - é€šç”¨å‡½æ•°åº“

## é€‚é…æ£€æŸ¥ç»“æœ

### âœ… script_util.py é€‚é…æƒ…å†µ

**æ ¸å¿ƒå‡½æ•°æ”¯æŒï¼š**
- `create_model_and_diffusion()` å‡½æ•°å·²å®Œå…¨æ”¯æŒ HAE æ¨¡å‹
- `create_model()` å‡½æ•°é€šè¿‡ `unet_ver` å‚æ•°æ”¯æŒä¸‰ç§ HAE å˜ä½“
- `model_and_diffusion_defaults()` åŒ…å«æ‰€æœ‰å¿…è¦çš„ HAE å‚æ•°

**å‚æ•°æ”¯æŒï¼š**
```python
# HAE ç›¸å…³å‚æ•°
use_hae=False,           # å¯ç”¨ HAE åŠŸèƒ½
bottleneck_ratio=0.25,   # HAE V2 çš„ç“¶é¢ˆæ¯”ç‡
unet_ver="v2",           # æ¨¡å‹ç‰ˆæœ¬é€‰æ‹©
clf_free=True,           # åˆ†ç±»å™¨è‡ªç”±å¼•å¯¼
```

**æ¨¡å‹å¯¼å…¥é€»è¾‘ï¼š**
```python
if unet_ver == "hae":
    from .unet_hae import HAEUNetModel as UNetModel
elif unet_ver == "hae_lite":
    from .unet_hae_lite import HAEUNetModelLite as UNetModel
elif unet_ver == "hae_v2":
    from .unet_hae_v2 import HAEUNetModelV2 as UNetModel
```

### âœ… è®­ç»ƒè„šæœ¬é€‚é…æƒ…å†µ

#### train_hae.py
- **çŠ¶æ€ï¼š** âœ… å®Œå…¨é€‚é…
- **é…ç½®ï¼š** å¼ºåˆ¶è®¾ç½® `unet_ver="hae"` å’Œ `use_hae=True`
- **å‚æ•°ä¼ é€’ï¼š** é€šè¿‡ `create_model_and_diffusion()` æ­£ç¡®åˆ›å»º HAE æ¨¡å‹

#### train_hae_lite.py
- **çŠ¶æ€ï¼š** âœ… å®Œå…¨é€‚é…
- **é…ç½®ï¼š** å¼ºåˆ¶è®¾ç½® `unet_ver="hae_lite"` å’Œ `use_hae=True`
- **ç‰¹ç‚¹ï¼š** æ”¯æŒè½»é‡åŒ– HAE æ¨¡å‹è®­ç»ƒ

#### train_hae_v2.py
- **çŠ¶æ€ï¼š** âœ… å®Œå…¨é€‚é…
- **é…ç½®ï¼š** å¼ºåˆ¶è®¾ç½® `unet_ver="hae_v2"` å’Œ `use_hae=True`
- **ç‰¹ç‚¹ï¼š** æ”¯æŒ `bottleneck_ratio` å‚æ•°é…ç½®

### âœ… æ¨ç†è„šæœ¬é€‚é…æƒ…å†µ

#### translation_FPDM_hae.py
- **çŠ¶æ€ï¼š** âœ… å®Œå…¨é€‚é…
- **é…ç½®ï¼š** å¼ºåˆ¶è®¾ç½® `unet_ver="hae"` å’Œ `use_hae=True`
- **åŠŸèƒ½ï¼š** é€šè¿‡ `read_model_and_diffusion()` æ­£ç¡®åŠ è½½ HAE æ¨¡å‹

#### translation_FPDM_hae_lite.py
- **çŠ¶æ€ï¼š** âœ… å®Œå…¨é€‚é…
- **é…ç½®ï¼š** å¼ºåˆ¶è®¾ç½® `unet_ver="hae_lite"` å’Œ `use_hae=True`
- **åŠŸèƒ½ï¼š** æ”¯æŒ HAE Lite æ¨¡å‹æ¨ç†

#### translation_FPDM_hae_v2.py
- **çŠ¶æ€ï¼š** âœ… å®Œå…¨é€‚é…
- **é…ç½®ï¼š** å¼ºåˆ¶è®¾ç½® `unet_ver="hae_v2"` å’Œ `use_hae=True`
- **åŠŸèƒ½ï¼š** æ”¯æŒ HAE V2 æ¨¡å‹æ¨ç†ï¼ŒåŒ…å« `bottleneck_ratio` å‚æ•°

### âœ… é€šç”¨å·¥å…·é€‚é…æƒ…å†µ

#### common.py
- **çŠ¶æ€ï¼š** âœ… å®Œå…¨é€‚é…
- **åŠŸèƒ½ï¼š** `read_model_and_diffusion()` å‡½æ•°é€šè¿‡è°ƒç”¨ `create_model_and_diffusion()` æ”¯æŒ HAE æ¨¡å‹åŠ è½½
- **å…¼å®¹æ€§ï¼š** ä¸æ‰€æœ‰ HAE å˜ä½“å®Œå…¨å…¼å®¹

## å…¼å®¹æ€§æµ‹è¯•ç»“æœ

### æ¨¡å‹åˆ›å»ºæµ‹è¯•
```
ğŸ§ª æµ‹è¯• HAE UNet (åŸç‰ˆ)...
   âœ… æ¨¡å‹åˆ›å»ºæˆåŠŸ
   æ¨¡å‹å‚æ•°æ•°é‡: 143.99M
   âœ… å‰å‘ä¼ æ’­æˆåŠŸ
   âœ… è¾“å‡ºå½¢çŠ¶æ­£ç¡®: torch.Size([2, 3, 64, 64])

ğŸ§ª æµ‹è¯• HAE UNet Lite...
   âœ… æ¨¡å‹åˆ›å»ºæˆåŠŸ
   æ¨¡å‹å‚æ•°æ•°é‡: 102.85M
   âœ… å‰å‘ä¼ æ’­æˆåŠŸ
   âœ… è¾“å‡ºå½¢çŠ¶æ­£ç¡®: torch.Size([2, 3, 64, 64])

ğŸ§ª æµ‹è¯• HAE UNet V2...
   âœ… æ¨¡å‹åˆ›å»ºæˆåŠŸ
   æ¨¡å‹å‚æ•°æ•°é‡: 99.45M
   âœ… å‰å‘ä¼ æ’­æˆåŠŸ
   âœ… è¾“å‡ºå½¢çŠ¶æ­£ç¡®: torch.Size([2, 3, 64, 64])
```

### å‚æ•°å…¼å®¹æ€§æµ‹è¯•
```
ğŸ“‹ æ£€æŸ¥å¿…è¦å‚æ•°:
   âœ… use_hae: False
   âœ… bottleneck_ratio: 0.25
   âœ… unet_ver: v2
   âœ… clf_free: True
   âœ… use_bea: False
   âœ… use_multi_bea: False
   âœ… use_bottleneck_bea: False

âœ… æ‰€æœ‰å¿…è¦å‚æ•°éƒ½å­˜åœ¨
```

### args_to_dict å…¼å®¹æ€§æµ‹è¯•
```
ğŸ”„ æµ‹è¯•args_to_dictå…¼å®¹æ€§...
   âœ… args_to_dictè½¬æ¢æˆåŠŸ
   è½¬æ¢çš„å‚æ•°æ•°é‡: 33
   âœ… unet_ver: v2
   âœ… use_hae: False
   âœ… bottleneck_ratio: 0.25
```

## å…³é”®é€‚é…ç‰¹æ€§

### 1. ç‰ˆæœ¬é€‰æ‹©æœºåˆ¶
- é€šè¿‡ `unet_ver` å‚æ•°ç»Ÿä¸€ç®¡ç†ä¸åŒ HAE å˜ä½“
- æ”¯æŒ "hae"ã€"hae_lite"ã€"hae_v2" ä¸‰ç§ç‰ˆæœ¬
- è‡ªåŠ¨å¯¼å…¥å¯¹åº”çš„æ¨¡å‹ç±»

### 2. å‚æ•°ä¼ é€’æœºåˆ¶
- `use_hae` å‚æ•°æ§åˆ¶ HAE åŠŸèƒ½å¯ç”¨
- `bottleneck_ratio` å‚æ•°ä¸“é—¨ç”¨äº HAE V2
- æ‰€æœ‰å‚æ•°é€šè¿‡ `model_and_diffusion_defaults()` ç»Ÿä¸€ç®¡ç†

### 3. å‘åå…¼å®¹æ€§
- ä¿æŒä¸åŸå§‹ FPDM å¤„ç†é€»è¾‘çš„å…¼å®¹
- ä¸å½±å“å…¶ä»–æ¨¡å‹å˜ä½“çš„æ­£å¸¸ä½¿ç”¨
- å‚æ•°é»˜è®¤å€¼è®¾ç½®åˆç†

## ç»“è®º

ğŸ‰ **æ‰€æœ‰ HAE æ¨¡å‹çš„è®­ç»ƒè„šæœ¬ã€æ¨ç†è„šæœ¬å’Œå·¥å…·æ–‡ä»¶å·²å®Œå…¨é€‚é…ä¿®æ”¹åçš„ç½‘ç»œç»“æ„ï¼**

### é€‚é…å®Œæˆåº¦
- âœ… è®­ç»ƒè„šæœ¬é€‚é…ï¼š100%
- âœ… æ¨ç†è„šæœ¬é€‚é…ï¼š100%
- âœ… å·¥å…·æ–‡ä»¶é€‚é…ï¼š100%
- âœ… å‚æ•°å…¼å®¹æ€§ï¼š100%
- âœ… åŠŸèƒ½æµ‹è¯•ï¼š100%

### ä¸»è¦æˆæœ
1. **ç»Ÿä¸€çš„ç‰ˆæœ¬ç®¡ç†**ï¼šé€šè¿‡ `unet_ver` å‚æ•°å®ç°äº†ä¸‰ç§ HAE å˜ä½“çš„ç»Ÿä¸€ç®¡ç†
2. **å®Œæ•´çš„å‚æ•°æ”¯æŒ**ï¼šæ‰€æœ‰ HAE ç‰¹æœ‰å‚æ•°éƒ½å¾—åˆ°æ­£ç¡®æ”¯æŒå’Œä¼ é€’
3. **å‘åå…¼å®¹**ï¼šä¿æŒäº†ä¸åŸå§‹ FPDM æ¡†æ¶çš„å®Œå…¨å…¼å®¹
4. **åŠŸèƒ½éªŒè¯**ï¼šæ‰€æœ‰æ¨¡å‹éƒ½èƒ½æ­£ç¡®åˆ›å»ºã€è®­ç»ƒå’Œæ¨ç†

### ä½¿ç”¨å»ºè®®
1. **è®­ç»ƒ HAE æ¨¡å‹**ï¼šç›´æ¥ä½¿ç”¨å¯¹åº”çš„è®­ç»ƒè„šæœ¬ï¼ˆ`train_hae.py`ã€`train_hae_lite.py`ã€`train_hae_v2.py`ï¼‰
2. **æ¨ç† HAE æ¨¡å‹**ï¼šä½¿ç”¨å¯¹åº”çš„æ¨ç†è„šæœ¬ï¼ˆ`translation_FPDM_hae*.py`ï¼‰
3. **å‚æ•°è°ƒæ•´**ï¼šé€šè¿‡å‘½ä»¤è¡Œå‚æ•°æˆ–é…ç½®æ–‡ä»¶è°ƒæ•´ `bottleneck_ratio` ç­‰ HAE ç‰¹æœ‰å‚æ•°

**HAE æ¨¡å‹è„šæœ¬é€‚é…å·¥ä½œå·²å…¨é¢å®Œæˆï¼Œå¯ä»¥æ­£å¸¸è¿›è¡Œè®­ç»ƒå’Œæ¨ç†ï¼**